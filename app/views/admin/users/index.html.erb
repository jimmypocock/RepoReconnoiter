<div class="mb-8">
  <h1 class="text-4xl font-bold text-gray-900 mb-2">Whitelist Management</h1>
  <p class="text-gray-600">Manage user access to RepoReconnoiter</p>
</div>

<!-- Add User Form -->
<div class="bg-white rounded-lg shadow p-6 mb-8">
  <h2 class="text-xl font-semibold text-gray-800 mb-4">Add User to Whitelist</h2>

  <%= form_with model: @whitelisted_user, url: admin_users_path, method: :post, class: "space-y-4" do |f| %>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <%= f.label :github_id, "GitHub ID *", class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= f.number_field :github_id, class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500", placeholder: "123456", required: true %>
        <p class="text-xs text-gray-500 mt-1">Numeric GitHub user ID (find at api.github.com/users/USERNAME)</p>
      </div>

      <div>
        <%= f.label :github_username, "GitHub Username *", class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= f.text_field :github_username, class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500", placeholder: "octocat", required: true %>
      </div>

      <div>
        <%= f.label :email, "Email (optional)", class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= f.email_field :email, class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500", placeholder: "user@example.com" %>
      </div>

      <div>
        <%= f.label :notes, "Notes (optional)", class: "block text-sm font-medium text-gray-700 mb-1" %>
        <%= f.text_field :notes, class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500", placeholder: "Why are they being whitelisted?" %>
      </div>
    </div>

    <div>
      <%= f.submit "Add User", class: "px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2" %>
    </div>
  <% end %>
</div>

<!-- Search and Filter -->
<div class="bg-white rounded-lg shadow p-6 mb-6">
  <%= form_with url: admin_users_path, method: :get, class: "flex flex-wrap gap-4 items-end" do %>
    <div class="flex-1 min-w-[200px]">
      <%= label_tag :search, "Search", class: "block text-sm font-medium text-gray-700 mb-1" %>
      <%= text_field_tag :search, params[:search], class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500", placeholder: "Username or email" %>
    </div>

    <div class="min-w-[150px]">
      <%= label_tag :filter, "Filter", class: "block text-sm font-medium text-gray-700 mb-1" %>
      <%= select_tag :filter, options_for_select([["All Users", ""], ["Admins Only", "admins"], ["Non-Admins", "non_admins"]], params[:filter]), class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" %>
    </div>

    <div>
      <%= submit_tag "Apply", class: "px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700" %>
      <%= link_to "Clear", admin_users_path, class: "px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 ml-2" %>
    </div>
  <% end %>
</div>

<!-- Users List -->
<div class="bg-white rounded-lg shadow overflow-hidden">
  <% if @whitelisted_users.any? %>
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
            User
          </th>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
            GitHub ID
          </th>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
            Stats
          </th>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
            Status
          </th>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
            Whitelisted
          </th>
          <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
            Actions
          </th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-200">
        <% @whitelisted_users.each do |whitelisted_user| %>
          <% user = whitelisted_user.users.first %>
          <tr>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="flex items-center">
                <div class="text-sm font-medium text-gray-900"><%= whitelisted_user.github_username %></div>
              </div>
              <% if whitelisted_user.email.present? %>
                <div class="text-xs text-gray-500"><%= whitelisted_user.email %></div>
              <% end %>
              <% if whitelisted_user.notes.present? %>
                <div class="text-xs text-gray-400 italic mt-1"><%= whitelisted_user.notes %></div>
              <% end %>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
              <%= whitelisted_user.github_id %>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <% if user %>
                <div class="text-sm text-gray-900"><%= user.comparisons.count %> comparisons</div>
                <div class="text-xs text-gray-500"><%= user.analyses.count %> analyses</div>
              <% else %>
                <div class="text-sm text-gray-400">Not signed in yet</div>
              <% end %>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <% if user&.admin? %>
                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-purple-100 text-purple-800">
                  Admin
                </span>
              <% else %>
                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                  User
                </span>
              <% end %>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
              <%= time_ago_in_words(whitelisted_user.created_at) %> ago
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
              <%= button_to "Remove", admin_user_path(whitelisted_user), method: :delete, data: { turbo_confirm: "Are you sure you want to remove #{whitelisted_user.github_username} from the whitelist?" }, class: "text-red-600 hover:text-red-900" %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>

    <!-- Pagination -->
    <% if @pagy.pages > 1 %>
      <div class="px-6 py-4 bg-gray-50 border-t border-gray-200 flex justify-center gap-2">
        <% if @pagy.prev %>
          <%= link_to "← Previous", admin_users_path(page: @pagy.prev, search: params[:search], filter: params[:filter]), class: "px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700" %>
        <% end %>
        <span class="px-4 py-2 text-gray-600">Page <%= @pagy.page %> of <%= @pagy.pages %></span>
        <% if @pagy.next %>
          <%= link_to "Next →", admin_users_path(page: @pagy.next, search: params[:search], filter: params[:filter]), class: "px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700" %>
        <% end %>
      </div>
    <% end %>
  <% else %>
    <div class="text-center py-12">
      <p class="text-gray-500">No whitelisted users found.</p>
      <% if params[:search].present? || params[:filter].present? %>
        <p class="text-sm text-gray-400 mt-2">Try clearing your search or filters.</p>
      <% end %>
    </div>
  <% end %>
</div>
