<div class="mb-8">
  <h1 class="text-4xl font-bold text-gray-900 mb-2">Admin Statistics</h1>
  <p class="text-gray-600">System-wide metrics and usage data</p>
</div>

<!-- Usage Stats -->
<div class="mb-4">
  <h2 class="text-2xl font-semibold text-gray-800 mb-3">Usage</h2>
</div>
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
  <%= render "stat_card",
    title: "Repositories Indexed",
    value: number_with_delimiter(@presenter.repositories_count),
    icon_color: "blue",
    icon: "folder" %>

  <%= render "stat_card",
    title: "Comparisons Created",
    value: number_with_delimiter(@presenter.comparisons_count),
    icon_color: "green",
    icon: "clipboard" %>

  <%= render "stat_card",
    title: "Total Views",
    value: number_with_delimiter(@presenter.total_views),
    icon_color: "purple",
    icon: "eye" %>
</div>

<!-- AI Spending Stats -->
<div class="mb-4">
  <h2 class="text-2xl font-semibold text-gray-800 mb-3">AI Spending</h2>
</div>
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
  <%= render "stat_card",
    title: "Today",
    value: "$#{number_with_precision(@presenter.ai_spend_today, precision: 4)}",
    icon_color: "blue",
    icon: "chart" %>

  <%= render "stat_card",
    title: "This Week",
    value: "$#{number_with_precision(@presenter.ai_spend_this_week, precision: 4)}",
    icon_color: "purple",
    icon: "chart" %>

  <%= render "stat_card",
    title: "This Month",
    value: "$#{number_with_precision(@presenter.ai_spend_this_month, precision: 4)}",
    icon_color: "orange",
    icon: "dollar" %>

  <%= render "stat_card",
    title: "Projected Monthly",
    value: "$#{number_with_precision(@presenter.ai_spend_projected, precision: 2)}",
    icon_color: "red",
    icon: "chart" %>

  <%= render "stat_card",
    title: "Total All Time",
    value: "$#{number_with_precision(@presenter.ai_spend_total, precision: 2)}",
    icon_color: "green",
    icon: "dollar" %>
</div>

<!-- Budget Status -->
<%
  status_color = case @presenter.budget_status
  when :healthy then "green"
  when :warning then "yellow"
  when :critical then "orange"
  when :exceeded then "red"
  end
%>
<div class="mb-4">
  <h2 class="text-2xl font-semibold text-gray-800 mb-3">Budget Status</h2>
</div>
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
  <%= render "stat_card",
    title: "Status",
    value: @presenter.budget_status.to_s.upcase,
    icon_color: status_color,
    icon: "chart" %>

  <%= render "stat_card",
    title: "Budget Used",
    value: "#{@presenter.budget_percentage_used}%",
    icon_color: status_color,
    icon: "chart" %>

  <%= render "stat_card",
    title: "Budget Remaining",
    value: "$#{number_with_precision(@presenter.budget_remaining, precision: 2)}",
    icon_color: "blue",
    icon: "dollar" %>
</div>

<% if @presenter.budget_status == :exceeded %>
  <div class="mt-6 p-4 bg-red-50 border border-red-200 rounded-lg">
    <p class="text-red-800 font-semibold">⚠️ WARNING: Monthly budget exceeded!</p>
  </div>
<% elsif @presenter.budget_status == :critical %>
  <div class="mt-6 p-4 bg-orange-50 border border-orange-200 rounded-lg">
    <p class="text-orange-800 font-semibold">⚠️ WARNING: Approaching budget limit!</p>
  </div>
<% end %>

<!-- Spend by Model -->
<div class="mt-8 mb-4">
  <h2 class="text-2xl font-semibold text-gray-800 mb-3">Spend by Model (This Month)</h2>
</div>
<div class="bg-white rounded-lg shadow p-6 mb-8">
  <% if @presenter.spend_by_model.any? %>
    <div class="space-y-4">
      <% @presenter.spend_by_model.each do |breakdown| %>
        <div class="flex items-center justify-between">
          <div class="flex-1">
            <div class="flex items-center justify-between mb-1">
              <span class="text-sm font-medium text-gray-700"><%= breakdown[:model] %></span>
              <span class="text-sm text-gray-600"><%= breakdown[:percentage] %>%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
              <div class="bg-blue-600 h-2 rounded-full" style="width: <%= breakdown[:percentage] %>%"></div>
            </div>
            <div class="flex items-center justify-between mt-1">
              <span class="text-xs text-gray-500"><%= number_with_delimiter(breakdown[:requests]) %> requests</span>
              <span class="text-xs font-semibold text-gray-700">$<%= number_with_precision(breakdown[:cost], precision: 4) %></span>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  <% else %>
    <p class="text-gray-500 text-center py-4">No AI spending data for this month</p>
  <% end %>
</div>

<!-- Spend by User -->
<div class="mb-4">
  <h2 class="text-2xl font-semibold text-gray-800 mb-3">Top Users by Spend (This Month)</h2>
</div>
<div class="bg-white rounded-lg shadow overflow-hidden mb-8">
  <% if @presenter.spend_by_user.any? %>
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
            User
          </th>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
            Requests
          </th>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
            Cost
          </th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-200">
        <% @presenter.spend_by_user.each_with_index do |user_stat, index| %>
          <tr class="<%= index.even? ? 'bg-white' : 'bg-gray-50' %>">
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="flex items-center">
                <div class="flex-shrink-0 h-8 w-8">
                  <% if user_stat[:user].github_avatar_url.present? %>
                    <img class="h-8 w-8 rounded-full" src="<%= user_stat[:user].github_avatar_url %>" alt="<%= user_stat[:user].github_username %>">
                  <% else %>
                    <div class="h-8 w-8 rounded-full bg-gray-300 flex items-center justify-center">
                      <span class="text-gray-600 text-xs"><%= user_stat[:user].github_username&.first&.upcase %></span>
                    </div>
                  <% end %>
                </div>
                <div class="ml-3">
                  <div class="text-sm font-medium text-gray-900"><%= user_stat[:user].github_username %></div>
                  <div class="text-xs text-gray-500"><%= user_stat[:user].email %></div>
                </div>
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
              <%= number_with_delimiter(user_stat[:requests]) %>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900">
              $<%= number_with_precision(user_stat[:cost], precision: 4) %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  <% else %>
    <p class="text-gray-500 text-center py-8">No user spending data for this month</p>
  <% end %>
</div>
